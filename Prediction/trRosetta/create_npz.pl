#!/usr/bin/perl
## Pombert Lab 2020
my $version = '0.2';
my $name = 'create_npz.pl';
my $updated = '2021-07-23';

use strict; use warnings; use Getopt::Long qw(GetOptions); use File::Basename;

## Usage definition
my $USAGE = <<"OPTIONS";
NAME		${name}
VERSION		${version}
UPDATED		${updated}
SYNOPSIS	Creates .npz files with trRosetta from .a3m files created by hhblits
REQUIREMENTS	trRosetta - https://github.com/gjoni/trRosetta
		tensorflow 1.15 - https://www.tensorflow.org/

NOTES		Probably best to run in a conda environment...
NOTES		Can quickly eat through 8 Gb of VRAM with large a3m files...
NOTES		If so, instead try with: pip install tensorflow-cpu==1.15

COMMAND		${name} \\
		  -a HHBLITS/*.a3m \\
		  -o NPZ/ \\
		  -t /media/Data_3/opt/trRosetta

OPTIONS:
-a (--a3m)	.a3m files generated by hhblits
-o (--output)	Output folder [Default: ./]
-t (--trosetta)	tRosetta installation directory (TROSETTA_HOME)
-m (--model)	trRosetta model directory [Default: model2019_07]

NOTES:
- The -t option is not required if the environment variable \$TROSETTA_HOME is set, e.g.:
  export TROSETTA_HOME=/opt/tRosetta
OPTIONS
die "\n$USAGE\n" unless @ARGV;

## Defining options
my @a3m;
my $out = './';
my $trosetta_home;
my $model = 'model2019_07';
GetOptions(
	'a|a3m=s@{1,}' => \@a3m,
	'o|output=s' => \$out,
	't|trosetta=s' => \$trosetta_home,
	'm|model=s' => \$model
);

### Checking for tRosetta installation; environment variables in Perl are loaded in %ENV
# Checking installation folder
if (!defined $trosetta_home){
	if (exists $ENV{'TROSETTA_HOME'}){ $trosetta_home = $ENV{'TROSETTA_HOME'}; }
	else {
		print "WARNING: The tRosetta installation directory is not set as an environment variable (\$TROSETTA_HOME) and the -r option was not entered.\n";
		print "Please check if tRosetta was installed properly\n\n";
		exit;
	}
}
elsif (defined $trosetta_home){
	unless (-d $trosetta_home){ die "WARNING: Can't find tRosetta installation folder: $trosetta_home. Please check command line\n\n"; }
}

## Working on a3m files
unless (-d $out){
	mkdir ($out,0755) or die "Can't create folder $out: $!\n";
}

while (my $a3m = shift@a3m){

	my($name, $dir) = fileparse($a3m);
	my ($prefix) = $name =~ /^(\S+)\.(\w+)$/;

	print "\nWorking on file: $name\n\n";

	system "python \\
	  $trosetta_home/network/predict.py \\
	  -m $trosetta_home/$model \\
	  $a3m \\
	  $out/$prefix.npz";
}